:imagesdir: ../../assets/images
include::../style.adoc[]

== Activity: Enable OpenShift Service Mesh 

{rhossm} have been installed and configured in your cluster. You will now onboard `travel-agency` namespace to be managed by {rhossm}

=== Set up your workshop environment

You will need to access the OpenShift console and command line terminals to apply configurations.

. Make sure you have exited the RHEL server from the previous module. If needed, type `exit` in the lower terminal to exit out of the RHEL system.
+
[source,sh,role="execute",subs=attributes+]
----
exit
----
. Clear the output in both terminals to make it easier to work on the next steps.
+
[source,sh,role="execute",subs=attributes+]
----
clear
----
. Log in to both the terminals on the right side using the following command.
+
[source,sh,role="execute",subs=attributes+]
----
oc login -u admin -p {ocp_cluster_openshift_cluster_admin_password} https://172.30.0.1:443
----
.. Type `y` if your are prompted with `Use insecure connections? (y/n)`
.. You should see a `Login successful` message

// . We will be working primarily in the `travel-agency` namespace/project, so run the following command in one of the terminals to ensure the next steps are applied to it.
// +
// [source,sh,role="execute",subs=attributes+]
// ----
// oc project travel-agency
// ----
// +
// Expected output:
// +
// ```bash
// Now using project "travel-agency" on server "https://172.30.0.1:443".
// ```


== Review `travel-agency` namespace

Before enabling Istio sidecar proxy injection for the `travel-agency` namespace, let's review all the pods running within it. 

. Run the following command in the *upper terminal*.
+
[source,sh,role="execute",subs=attributes+]
----
oc get pods -n travel-agency
----
+
Example output:
+
----
NAME                             READY   STATUS    RESTARTS   AGE
cars-v1-d7b4b7cf-pm7nh           1/1     Running   0          113m
....
travels-v1-647d788486-wf4nm      1/1     Running   0          112m

----
. Each pod shows `1/1` under the `READY` column, indicating that each pod has a single container and it is running.  

. Check the namespace `travel-agency` configuration.
+
[source,sh,role="execute",subs=attributes+]
----
oc describe namespaces travel-agency
----
+
image:m2/oc-travel-agency.png[] 

. Look for the label: `istio-injection=disabled`
+
[NOTE]
====
The `istio-injection=disabled` label is the implicit default value and might always be present in the deployment. You can proceed to the next step even if it is not displayed.
====

. The Istio sidecars have not yet been deployed and the namespace has not been added to the mesh yet. Let's change that in the next step.

== Add `travel-agency` namespace to the mesh

Onboarding a namespace to the mesh can be done manually by editing/patching labels in the `travel-agency` namespace, or by using the Kiali console.  

In this module, you will use the Kiali consle to enable automatic Istio injection to the namespace. Service mesh will then automatically inject proxy sidecar containers into all pods in `travel-agency` namespace that will allow the service mesh to take manage them.

. Navigate to http://kiali-istio-system.{ocp_cluster_openshift_cluster_ingress_domain}/?namespace=travel-agency&opLabel=or[Kiali console, window="kiali"], and log in with username `admin` and password `{ocp_cluster_openshift_cluster_admin_password}` when prompted.
. You should automatically see a filtered view of the `travel-agency` namespace. If not, enter `travel-agency`  into the *Namespace* filter, and press *Enter* to make it easier to perform actions.
+
image:m2/namespace-filter.png[] 

. From the `travel-agency` tile, click the kebab menu (three horizontal dots), and choose *Enable Auto Injection*.
+
image:m2/kiali-enable-injection.png[]
. Confirm by clicking the *Enable* button.
+
image:m2/kiali-enable-injection-button.png[]
. This action adds `travel-agency` namespace to the mesh, and also set the namespace's Istio label to `istio-injection=enabled`

=== Validate auto-injection to `travel-agency`

Let's  another look at the `travel-agency` namespace to verify the update
. From the *upper terminal*, execute the following command once more.
+
[source,sh,role="execute",subs=attributes+]
----
oc describe namespaces travel-agency
----
+
Example output:
+
```
oc describe namespaces travel-agency
Name:         travel-agency
Labels:       app.kubernetes.io/instance=travel-agency
              istio-injection=enabled
              kubernetes.io/metadata.name=travel-agency
              ....
              pod-security.kubernetes.io/warn-version=latest
Annotations:  openshift.io/sa.scc.mcs: s0:c29,c19
              ....
Status:       Active
...

```
. You should now see: `istio-injection=enabled`. 
+
[.concept]
.What does the istio-injection=enabled do?
****
When you set the `istio-injection=enabled` label on a namespace, any new pods that are created in that namespace will automatically have a sidecar added to them.
****

=== Restarting Deployments

With injection enabled, we must restart the application pods to trigger sidecar injection.

. Since you have two terminals, in the *upper terminal*, run the following command. This will automatically run the `oc get pods` command every two seconds.
+
[source,sh,role="execute",subs=attributes+]
----
watch oc get pods -n travel-agency
----

. In the *lower terminal*, run the following command.
+
[source,sh,role="execute",subs=attributes+]
----
oc get deployments -n travel-agency -o name \
  | xargs -I{} oc rollout -n travel-agency restart {}
----
+
Expected output on the lower terminal.
+
```
deployment.apps/cars-v1 restarted
....
deployment.apps/travels-v1 restarted
```

. Once the applications have been restarted, the *lower terminal* will show that there are now 2 containers per pod.
+

```
NAME                             READY   STATUS    RESTARTS   AGE
cars-v1-8449bdcfcc-27ncs         2/2     Running   0          78s
discounts-v1-f4d97b4b8-78z8w     2/2     Running   0          78s
flights-v1-594f54d7b-lg7n4       2/2     Running   0          77s
hotels-v1-56fc4b478d-lcbn2       2/2     Running   0          77s
insurances-v1-5fc4b7cdf6-khkl5   2/2     Running   0          76s
mysqldb-v1-644c48c745-qq9ps      2/2     Running   0          76s
travels-v1-99798fc94-2xw74       2/2     Running   0          75s
```

You can now stop the `watch` command in the upper terminal with `Ctrl+C`
