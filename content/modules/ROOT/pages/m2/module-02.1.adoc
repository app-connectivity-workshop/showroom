:imagesdir: ../../assets/images
include::../style.adoc[]

== Activity: Enable OpenShift Service Mesh 

{rhossm} have been installed and configured in your cluster. 
In this section, you will make changes to the *travel-agency* namespace so the travel portal can take full advantage of {rhossm} by enabling Istio sidecar proxy injection.

By default, {rhossm} has visibility into all namespaces in the cluster. However, to actively manage Istio policies between services, we need to explicitly inject the service mesh sidecar proxies by setting annotations on the namespace resource. This can be done manually by editing/patching labels in the `travel-agency` namespace, or by using the Kiali console, which is the method we will use in the lab module.

Once the application is part of the service mesh, you can also use the Red Hat-provided Kiali Operator to visualize service traffic and gain observability into your application.

== Set up your workshop environment

You will need to access the OpenShift console and command line terminals to apply configurations.

. Make sure you have exited the RHEL server from the previous module. If needed, type `exit` in the lower terminal to exit out of the RHEL system.
+
[source,sh,role="execute",subs=attributes+]
----
exit
----
. Clear the output in both terminals to make it easier to work on the next steps.
+
[source,sh,role="execute",subs=attributes+]
----
clear
----
. Log in to both the terminals on the right side using the following command.
+
[source,sh,role="execute",subs=attributes+]
----
oc login -u admin -p {ocp_cluster_openshift_cluster_admin_password} https://172.30.0.1:443
----
.. Type `y` if your are prompted with `Use insecure connections? (y/n)`
.. You should see a `Login successful` message

// . We will be working primarily in the `travel-agency` namespace/project, so run the following command in one of the terminals to ensure the next steps are applied to it.
// +
// [source,sh,role="execute",subs=attributes+]
// ----
// oc project travel-agency
// ----
// +
// Expected output:
// +
// ```bash
// Now using project "travel-agency" on server "https://172.30.0.1:443".
// ```


== Enable Service Mesh for the `travel-agency` namespace

. Before enabling Istio sidecar proxy injection for the `travel-agency` namespace, let's review all the pods running within it. Run the following command in the *upper terminal*.
+
[source,sh,role="execute",subs=attributes+]
----
oc get pods -n travel-agency
----
+
Example output:
+
----
NAME                             READY   STATUS    RESTARTS   AGE
cars-v1-d7b4b7cf-pm7nh           1/1     Running   0          113m
....
travels-v1-647d788486-wf4nm      1/1     Running   0          112m

----
. Each pod shows `1/1` under the `READY` column, indicating that each pod has a single container and it is running.  

. Check the namespace `travel-agency` configuration.
+
[source,sh,role="execute",subs=attributes+]
----
oc describe namespaces travel-agency
----
+
image:m2/oc-travel-agency.png[] 

. Look for the label: `istio-injection=disabled`

. Even though the mesh manages the namespace, sidecars have not yet been deployed. Let's change that by updating the label to `istio-injection=enabled`.
+
[NOTE]
====
The `istio-injection=disabled` label is the implicit default value and might always be present in the deployment. You can proceed to the next step even if it is not displayed.
====

*Enabling Auto-Injection Using Kiali*

Kiali is part of Red Hat OpenShift Service Mesh and is an observability console for Istio that helps you monitor the structure and health of your service mesh. It displays traffic flow, service relationships, and errors.

image:m2/kiali-overview.png[]

. Navigate to http://kiali-istio-system.{ocp_cluster_openshift_cluster_ingress_domain}[Kiali console, window="kiali"], , and log in with username `admin` and password `{ocp_cluster_openshift_cluster_admin_password}` when prompted.


. In Kiali, go to the *Overview* tab, find the `travel-agency` tile, click the kabob menu (three dots), and choose *Enable Auto Injection*.
+
image:m2/kiali-enable-injection.png[]
. Confirm by clicking the *Enable* button.
+
image:m2/kiali-enable-injection-button.png[]
. Let's look at the `travel-agency` namespace to verify the update:
+
[source,sh,role="execute",subs=attributes+]
----
oc describe namespaces travel-agency
----
+
Example output:
```
oc describe namespaces travel-agency
Name:         travel-agency
Labels:       app.kubernetes.io/instance=travel-agency
              istio-injection=enabled
              kubernetes.io/metadata.name=travel-agency
              pod-security.kubernetes.io/audit=restricted
              pod-security.kubernetes.io/audit-version=latest
              pod-security.kubernetes.io/warn=restricted
              pod-security.kubernetes.io/warn-version=latest
Annotations:  openshift.io/sa.scc.mcs: s0:c29,c19
              openshift.io/sa.scc.supplemental-groups: 1000850000/10000
              openshift.io/sa.scc.uid-range: 1000850000/10000
Status:       Active
...

```
. You should now see: `istio-injection=enabled`
+
[.concept]
.What does the istio-injection=enabled do?
****
When you set the `istio-injection=enabled` label on a namespace, any new pods that are created in that namespace will automatically have a sidecar added to them.
****

=== Restarting Deployments

With injection enabled, we must restart the application pods to trigger sidecar injection.

. Since you have two terminals, in the *upper terminal*, run the following command. This will automatically run the `oc get pods` command every two seconds.
+
[source,sh,role="execute",subs=attributes+]
----
watch oc get pods -n travel-agency
----

. In the *lower terminal*, run the following command.
+
[source,sh,role="execute",subs=attributes+]
----
oc get deployments -n travel-agency -o name \
  | xargs -I{} oc rollout -n travel-agency restart {}
----
+
Expected output on the lower terminal.
+
```
deployment.apps/cars-v1 restarted
....
deployment.apps/travels-v1 restarted
```

. Once the applications have been restarted, the *lower terminal* will show that there are now 2 containers per pod.
+

```
NAME                             READY   STATUS    RESTARTS   AGE
cars-v1-8449bdcfcc-27ncs         2/2     Running   0          78s
discounts-v1-f4d97b4b8-78z8w     2/2     Running   0          78s
flights-v1-594f54d7b-lg7n4       2/2     Running   0          77s
hotels-v1-56fc4b478d-lcbn2       2/2     Running   0          77s
insurances-v1-5fc4b7cdf6-khkl5   2/2     Running   0          76s
mysqldb-v1-644c48c745-qq9ps      2/2     Running   0          76s
travels-v1-99798fc94-2xw74       2/2     Running   0          75s
```

You can now stop the `watch` command in the upper terminal with `Ctrl+C`
