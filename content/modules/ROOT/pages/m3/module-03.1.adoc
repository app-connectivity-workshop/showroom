:imagesdir: ../../assets/images
include::../style.adoc[]

== Module 3: Simplify and secure traffic management with {rhcl}

== Activity: Platform Engineer Workflow

To perform the section of the workshop, ensure you are logged into OpenShift within the terminal.

. In the *right-upper terminal*, running the following command should display `admin`
+
[source,sh,role="execute",subs=attributes+]
----
oc whoami
----
. If this is not the case, run the following command to log in to OpenShift.
+
[source,sh,role="execute",subs=attributes+]
----
oc login -u admin -p {ocp_cluster_openshift_cluster_admin_password} https://172.30.0.1:443
----

== Activity: Platform Engineer workflow

. Access the {ocp_cluster_openshift_cluster_console_url}[OpenShift console^, window="console"]. Login as *admin/{ocp_cluster_openshift_cluster_admin_password}* if prompted.
. Navigate to *Connectivity Link > Overview* menu found at the bottom of the left-hand navigation menu.
+
image:m3/rhcl-console-view.png[] 
. In the *Overview* section, you will notice that a *Gateway*, a *TLSPolicy*, a *DNSPolicy*, and an `echo-api` *HTTPRoute* have been pre-configured. 
+
image:m3/rhcl-inital-overview.png[]

+
[CAUTION]
====
The *Status* columns for all the resources should display as `Enforced` in green. If any `Status` shows an error, similar to the screenshot below, please notify the lab assistant immediately to address and rectify any issues.

image:m3/rhcl-error.png[] 
====

=== Review the Gateway

. Click on the `prod-web` Gateway to review it. Here is a snippet of the Gateway details
+
[source,sh,subs=attributes+]
----
spec:
  gatewayClassName: istio
  listeners:
    - allowedRoutes:
        namespaces:
          from: All
      hostname: '*.travels.{ocp_cluster_workshop_main_domain}' <1>
      name: api
      port: 443
      protocol: HTTPS
      tls:
        certificateRefs: <2>
          - group: ''
            kind: Secret
            name: api-tls 
        mode: Terminate
----
+
<1> This is the wildcarded hostname which will handle all traffic routed through the `travels.{ocp_cluster_workshop_main_domain}` domain
<2> A TLS Policy has been pre-created; it leverages a TLS-issuer to manage TLS certificates for the listeners defined within the Gateway.


=== Review the DNSPolicy

. A  *DNSPolicy* has been applied to the `prod-web` Gateway resource.  This DNS Policy has been pre-created because DNS resolution for new DNS records may take a few minutes.
. Click on the DNS Policy `prod-web-dnspolicy` and scroll to the bottom of the page to note that the DNSPolicy has been accepted and enforced.
+
image:m3/gw-dns-policy-created.png[]
. The message displayed against the `Enforced` is to notify you that there are no HTTPRoute custom resources (CRs) attached yet. This will change once a developer creates an HTTPRoute.
+
[TIP] 
====
DNS Policies can be created with more complex configurations especially for hybrid cloud architectures, including default Geo Code and load balancing options
====

=== Access the `echo-api` HTTPRoute

. The `echo-api` HTTPRoute has been deployed as a way for Platform Engineers to verify their setup before opening this up to developers.
. Execute the following `curl` command to access the `echo-api`
+
[source,sh,role="execute",subs=attributes+]
----
curl -k -w "%{http_code}" https://echo.travels.{ocp_cluster_workshop_main_domain} && echo
----
. You will observe that this endpoint is accessible without any authentication parameters, and returns an HTTP `200` successful response status code.
+
```yaml
{
  "method": "GET",
  ....
  "body": "",
  "headers": {
    "HTTP_HOST": "echo.travels.sandbox4962.opentlc.com",
    "HTTP_USER_AGENT": "curl/7.76.1",
    ....
    "HTTP_VERSION": "HTTP/1.1"
  },
  "uuid": "5dc42712-53c3-4f3d-94ec-9d96a501b213"
}200
```
. This is not the intended behavior and needs to be addressed. In the next step, you will create an *AuthPolicy* to secure this endpoint.

== Create a zero-trust AuthPolicy

As a Platform Engineer, you will now set up a zero-trust *AuthPolicy* to secure your services.

. Click the *(+)* button on the top navigation bar of {ocp_cluster_openshift_cluster_console_url}[OpenShift Console^, window="console"] to create a new resource.
. In the YAML editor, copy the following *AuthPolicy* CR.
+
[source,sh,role="execute",subs=attributes+]
----
apiVersion: kuadrant.io/v1
kind: AuthPolicy
metadata:
  name: prod-web-deny-all
  namespace: ingress-gateway
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: prod-web
  rules:
    authorization:
      deny-all:
        opa:
          rego: "allow = false"
    response:
      unauthorized:
        headers:
          "content-type":
            value: application/json
        body:
          value: |
            {
              "error": "Forbidden",
              "message": "Access denied by default by the gateway operator. If you are the administrator of the service, create a specific auth policy for the route."
            }

----
. This policy denies all incoming requests and sends a custom error message as part of the response.
. Click the *Create* button at the bottom of the YAML editor
. Scroll to the bottom of the *AuthPolicy details* page to note that the policy has been accepted and enforced
+
image:m3/gw-ap-created.png[] 


=== Create a default low-limit RateLimitPolicy

. Click the *(+)* button on the top navigation bar of {ocp_cluster_openshift_cluster_console_url}[OpenShift Console^, window="console"] to create a new resource.
. In the YAML editor, copy the following RateLimitPolicy CR and save it
+
[source,sh,role="execute",subs=attributes+]
----
apiVersion: kuadrant.io/v1
kind: RateLimitPolicy
metadata:
  name: ingress-gateway-rlp-lowlimits
  namespace: ingress-gateway
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: prod-web
  limits:
    "default-limits":
      rates:
      - limit: 5
        window: 10s
----
. Click the *Create* button at the bottom of the YAML editor
+
image:m3/gw-rlp-yaml.png[width=70%] 
. Scroll to the bottom of the RateLimitPolicy details page to note that the RateLimitPolicy has been accepted and enforced.
+
image:m3/gw-rlp-created.png[]

== Test the setup so far

Test the `echo-api` HTTPRoute to test the setup so far, to ensure all requests are denied due to the zero trust policy you have set up

. Execute the following `curl` command on the *upper* Terminal to access the `echo-api`
+
[source,sh,role="execute",subs=attributes+]
----
curl -k -w "%{http_code}" https://echo.travels.{ocp_cluster_workshop_main_domain} && echo
----
. This should display an error message. Note that this is the same response as configured in the Gateway.
+
```yaml
{
  "error": "Forbidden",
  "message": "Access denied by default by the gateway operator. If you are the administrator of the service, create a specific auth policy for the route."
}
```
+
This error message is caused by the zero-trust AuthPolicy applied to the Gateway to which the `API` HTTPRoute is attached. Since no other AuthPolicy is attached to `echo-api,` the Gateway's AuthPolicy is  enforced on it.
+
[WARNING] 
====
There is a possibility that you may face such an error: `curl: (6) Could not resolve host: echo.travels.sandbo123.opentlc.com`. This may occur because DNS resolution can take a few minutes. Please try again in a minute or two.
====

. Navigate to {rhcl}'s {ocp_cluster_openshift_cluster_console_url}/kuadrant/policy-topology[Policy Topology^, window="console"].
. Note that the Auth, DNS, Rate Limit, and TLS policies are all attached to the `prod-web` Gateway, and are inherited by the `echo-api` HTTRoute.
+
image:m3/echoapi-topology.png[] 


== Conclusion

. You explored the Platform Engineer's workflow, setting up the Gateway, TLS Policy, DNS Policy, and Auth Policy.
. You validated the `echo-api` HTTPRoute and confirmed access was denied as expected.
. Next, you'll follow the App Developer's workflow to expose a Travels Service route and apply specific policies to allow secure access to the core services endpoints
