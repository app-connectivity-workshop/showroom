:imagesdir: ../../assets/images
include::../style.adoc[]

== Module 3: Simplify and secure traffic management with {rhcl}

== Activity: Platform Engineer Workflow

To perform the section of the workshop, ensure you are logged into OpenShift within the terminal.

. In the *right-upper terminal*, running the following command should display `admin`
+
[source,sh,role="execute",subs=attributes+]
----
oc whoami
----
. If this is not the case, run the following command to log in to OpenShift.
+
[source,sh,role="execute",subs=attributes+]
----
oc login -u admin -p {ocp_cluster_openshift_cluster_admin_password} https://172.30.0.1:443
----

== Activity: Platform Engineer workflow

The {rhcl} operator has already been set up amongst several other components. 

. Access the {ocp_cluster_openshift_cluster_console_url}[OpenShift console^, window="console"]. Login as *admin/{ocp_cluster_openshift_cluster_admin_password}* if prompted.
. Navigate to *Connectivity Link > Overview* menu found at the bottom of the left-hand navigation menu.
+
image:m3/rhcl-console-view.png[] 
. In the *Overview* section, you will notice that a *Gateway*, a *TLSPolicy*, a *DNSPolicy*, and a sample *HTTPRoute* have been pre-configured. This helps ensure the workshop can be completed in the allotted time.
+
image:m3/rhcl-inital-overview.png[]


=== Review the Gateway

. You can view the `prod-web` Gateway by clicking on it. Here is a snippet of the Gateway details
+
[source,sh,subs=attributes+]
----
spec:
  gatewayClassName: istio
  listeners:
    - allowedRoutes:
        namespaces:
          from: All
      hostname: '*.travels.{ocp_cluster_workshop_main_domain}' <1>
      name: api
      port: 443
      protocol: HTTPS
      tls:
        certificateRefs: <2>
          - group: ''
            kind: Secret
            name: api-tls 
        mode: Terminate
----
+
<1> This is the wildcarded hostname which will handle all traffic routed through the `travels.{ocp_cluster_workshop_main_domain}` domain
<2> A TLS Policy has been pre-created; it leverages a TLS-issuer to manage TLS certificates for the listeners defined within the Gateway.


=== Review the DNSPolicy

. A  *DNSPolicy* Custom Resource has been created. Review a snippet below.
+
[source,sh, subs=attributes+]
----
spec:
  targetRef:
    name: prod-web  <1>
    group: gateway.networking.k8s.io
    kind: Gateway
  providerRefs:
  - name: prod-web-aws-credentials  <2>
----
+
<1> `prod-web` Gateway resource to which this policy is applied
<2> DNS Provider credentials as a secret, so that DNS records can be created
. Click on the DNS Policy `prod-web-dnspolicy` and scroll to the bottom of the page to note that the DNSPolicy has been accepted and enforced.
+
image:m3/gw-dns-policy-created.png[]
+
[NOTE]
====
* The message displayed against the `Enforced` is to notify you that there are no HTTPRoute custom resources (CRs) attached yet. This will change once a developer creates an HTTPRoute
* This DNS Policy has been pre-created because DNS resolution for new DNS records may take a few minutes.
====
. A DNSPolicy creates an appropriate DNSRecord created on the DNS provider, AWS Route53, in this case. +
Run the following command on the *top-right terminal*, to view the endpoint of the DNSRecord.
+
[source,sh,role="execute",subs=attributes+]
----
oc get dnsrecord.kuadrant.io/prod-web-api -n ingress-gateway  -o jsonpath='{.spec.endpoints[*].targets[*]}' && echo
----

. You will see an output like this `a49e9cf51674b4f93854c55ed5d33484-1568847220.us-east-2.elb.amazonaws.com`, which is the last endpoint that was successfully published by the provider (AWS Route53).
+ 
.[.underline]#*Click to learn more about DNSPolicy loadbalancing options*#
[%collapsible]
====

* DNS Policies can be created with more complex configurations as well, including default Geo Code, load balancing options - especially in a hybrid cloud setup.
* "load-balanced" means we configure the DNS provider to return different gateway/load balancer addresses to DNS clients' queries based on specific weighting and geolocation configuration. 
* E.g., you can define a default `GEO-EU` 
+
```yaml
  loadBalancing:
    weight: 120 
    geo: GEO-EU 
    defaultGeo: true
```
* This allows for location-aware routing of requests. With the proper configuration, requests from the US can be routed to a Gateway (CR) setup in a US cluster, and all other requests can be routed to a default `GEO-EU` cluster
* Learn more https://docs.kuadrant.io/1.0.x/kuadrant-operator/doc/user-guides/dns/load-balanced-dns/[here, window="content"]

====



=== Access the `echo-api` HTTPRoute

. The `echo-api` HTTPRoute has been set up as a way for Platform Engineers to test their configuration before opening this up to developers.
. Execute the following `curl` command to access the `echo-api`
+
[source,sh,role="execute",subs=attributes+]
----
curl -k -w "%{http_code}" https://echo.travels.{ocp_cluster_workshop_main_domain} && echo
----
. You will observe that this endpoint is accessible without any authentication parameters.

+
```yaml
{
  "method": "GET",
  "path": "/",
  "query_string": null,
  "body": "",
  "headers": {
    "HTTP_HOST": "echo.travels.sandbox4962.opentlc.com",
    "HTTP_USER_AGENT": "curl/7.76.1",
    "HTTP_ACCEPT": "*/*",
    "HTTP_X_FORWARDED_FOR": "100.64.0.2",
    "HTTP_X_FORWARDED_PROTO": "https",
    "HTTP_X_ENVOY_EXTERNAL_ADDRESS": "100.64.0.2",
    "HTTP_X_REQUEST_ID": "592d2f86-16a4-4191-bd4f-403d60b9d99f",
    "HTTP_X_ENVOY_DECORATOR_OPERATION": "echo-api.echo-api.svc.cluster.local:8080/*",
    "HTTP_X_ENVOY_PEER_METADATA_ID": "router~10.128.0.209~prod-web-istio-75575555b6-48kmm.ingress-gateway~ingress-gateway.svc.cluster.local",
    "HTTP_X_ENVOY_PEER_METADATA": "ChoKCkNMVVNURVJfSUQSDBoKS3ViZ..",
    "HTTP_X_ENVOY_ATTEMPT_COUNT": "1",
    "HTTP_VERSION": "HTTP/1.1"
  },
  "uuid": "5dc42712-53c3-4f3d-94ec-9d96a501b213"
}200
```
. This is not the intended outcome and needs to be fixed. In the next step, you will create an AuthPolicy to secure this endpoint.

== Create a zero-trust AuthPolicy

As a Platform Engineer, you will now set up a zero-trust *AuthPolicy* to secure your services.

. Click the *(+)* button on the top navigation bar of {ocp_cluster_openshift_cluster_console_url}[OpenShift Console^, window="console"] to create a new resource.
. In the YAML editor, copy the following *AuthPolicy* CR.
+
[source,sh,role="execute",subs=attributes+]
----
apiVersion: kuadrant.io/v1
kind: AuthPolicy
metadata:
  name: prod-web-deny-all
  namespace: ingress-gateway
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: prod-web
  rules:
    authorization:
      deny-all:
        opa:
          rego: "allow = false"
    response:
      unauthorized:
        headers:
          "content-type":
            value: application/json
        body:
          value: |
            {
              "error": "Forbidden",
              "message": "Access denied by default by the gateway operator. If you are the administrator of the service, create a specific auth policy for the route."
            }

----
. This policy denies all incoming requests and sends a custom error message as part of the response.
. Click the *Create* button at the bottom of the YAML editor
. Scroll to the bottom of the *AuthPolicy details* page to note that the policy has been accepted and enforced
+
image:m3/gw-ap-created.png[] 


=== Create a default low-limit RateLimitPolicy

. In the YAML editor, copy the following RateLimitPolicy CR and save it
+
[source,sh,role="execute",subs=attributes+]
----
apiVersion: kuadrant.io/v1
kind: RateLimitPolicy
metadata:
  name: ingress-gateway-rlp-lowlimits
  namespace: ingress-gateway
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: prod-web
  limits:
    "default-limits":
      rates:
      - limit: 5
        window: 10s
----
. Click the *Create* button at the bottom of the YAML editor
+
image:m3/gw-rlp-yaml.png[width=70%] 
. Scroll to the bottom of the RateLimitPolicy details page to note that the RateLimitPolicy has been accepted and enforced.
+
image:m3/gw-rlp-created.png[]

== Test the setup so far

Let us now test the `echo-api` HTTPRoute to test the setup so far, to ensure all requests are denied due to the zero trust policy we have set up

. Execute the following `curl` command to access the `echo-api`
+
[source,sh,role="execute",subs=attributes+]
----
curl -k -w "%{http_code}" https://echo.travels.{ocp_cluster_workshop_main_domain} && echo
----
. This should display an error message. You may note this is the same response as the one configured in the Gateway.
+
```yaml
{
  "error": "Forbidden",
  "message": "Access denied by default by the gateway operator. If you are the administrator of the service, create a specific auth policy for the route."
}
```
+
[WARNING] 
====
* There is a possibility that you might face such an error `curl: (6) Could not resolve host: echo.travels.sandbo123.opentlc.com`
* This is because the DNS resolution may take a few minutes. Please retry in a minute or two.
====

This error message is caused by the zero-trust AuthPolicy that was applied to the Gateway to which the `API` HTTPRoute is attached. Since no other AuthPolicy is attached to `echo-api,` the Gateway's AuthPolicy is  enforced on it.

. Navigate to {rhcl}'s {ocp_cluster_openshift_cluster_console_url}/kuadrant/policy-topology[Policy Topology^, window="console"].
. Note that the Auth, DNS, Rate Limit, and TLS policies are all attached to the `prod-web` Gateway, and are inherited by the `echo-api` HTTRoute.
+
image:m3/echoapi-topology.png[] 


== Conclusion

. In this activity, you explored a Platform Engineer's workflow. With the Gateway, TLS Policy, DNS Policy, and Auth Policy, you have set up the proper guardrails to build upon.
. You have validated with the `echo-api` HTTPRoute and confirmed that access was denied as expected.
. In the next steps, you will perform an App Developer's workflow to expose a Travels Service route and apply specific policies on the HTTPRoute resource so as to override the Gateway's default policies.
