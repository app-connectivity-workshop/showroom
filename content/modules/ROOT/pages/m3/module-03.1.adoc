:imagesdir: ../../assets/images
include::../style.adoc[]


== Activity: Platform Engineer workflow

== Enable the {rhcl} plugin
. Navigate to {ocp_cluster_openshift_cluster_console_url}/k8s/cluster/operator.openshift.io~v1~Console/cluster/console-plugins[console-plugins^]
. From the Console Plugins list, click on the disabled link against `kuadrant-console-plugin` to enable this plugin
+
image:m3/kuadrant-console-plugin.png[] 
. Choose `enable` option, and click *Save*
+
image:m3/kuadrant-console-plugin-popup.png[] 
+
image:m3/kuadrant-console-plugin-enable.png[] 
. In a couple of minutes, you will be notified that a Web console update is available. 
+
image:m3/kuadrant-console-plugin-available.png[] 
. You can refresh your browser to access the {rhcl} plugin link that will appear on the bottom of the left-hand navigation

=== Explore the setup

. A Gateway (based on Istio Gateway) with a wildcard hostname `*.travels.{ocp_cluster_openshift_cluster_ingress_domain}` has already been created. 


. Navigate to the {ocp_cluster_openshift_cluster_console_url}[OpenShift Console^, window="console"]. Login as admin/{ocp_cluster_openshift_cluster_admin_password} if prompted.
. Click the (+) button on the top navigation bar of OpenShift Console to create a new resource.
+
image:m3/create-yaml.png[] 
. In the YAML editor, copy the following Gateway CR
+
[source,sh,role="execute",subs=attributes+]
----
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: prod-web
  namespace: ingress-gateway
  labels:
    app.kubernetes.io/instance: ingress-gateway
    kuadrant.io/lb-attribute-geo-code: EU
spec:
  gatewayClassName: istio
  listeners:
    - allowedRoutes:
        namespaces:
          from: All
      hostname: '*.{ocp_cluster_workshop_main_domain}'
      name: api
      port: 443
      protocol: HTTPS
      tls:
        certificateRefs:
          - group: ''
            kind: Secret
            name: api-tls
        mode: Terminate
----
. Click the *Save* button to create the Gateway

=== Create a DNSPolicy

. In the YAML editor, copy the following DNSPolicy CR and save
+
[source,sh,role="execute",subs=attributes+]
----
apiVersion: kuadrant.io/v1
kind: DNSPolicy
metadata:
  name: prod-web-dnspolicy
  namespace: ingress-gateway
spec:
  targetRef:
    name: prod-web
    group: gateway.networking.k8s.io
    kind: Gateway
  providerRefs:
  - name: prod-web-aws-credentials
----
. Scroll to the bottom of the page to note that the DNSPolicy has been accepted and enforced
+
image:m3/gw-dns-policy-created.png[] 


=== Create a zero-trust AuthPolicy


. In the YAML editor, copy the following AuthPolicy CR and save
+
[source,sh,role="execute",subs=attributes+]
----
apiVersion: kuadrant.io/v1
kind: AuthPolicy
metadata:
  name: prod-web-deny-all
  namespace: ingress-gateway
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: prod-web
  rules:
    authorization:
      deny-all:
        opa:
          rego: "allow = false"
    response:
      unauthorized:
        headers:
          "content-type":
            value: application/json
        body:
          value: |
            {
              "error": "Forbidden",
              "message": "Access denied by default by the gateway operator. If you are the administrator of the service, create a specific auth policy for the route."
            }

----
. Click the Create button at the bottom of the YAML editor
+
image:m3/gw-auth-create-yaml.png[] 
. Scroll to the bottom of the page to note that the DNSPolicy has been accepted and enforced
+
image:m3/gw-auth-policy-created.png[] 
 


=== Create a default low-limit RateLimitPolicy

. In the YAML editor, copy the following AuthPolicy CR and save
+
[source,sh,role="execute",subs=attributes+]
----
apiVersion: kuadrant.io/v1
kind: RateLimitPolicy
metadata:
  name: ingress-gateway-rlp-lowlimits
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: ingress-gateway
  limits:
    "default-limits":
      rates:
      - limit: 5
        window: 10s
----


== Test EchoAPI


curl -k -w "%{http_code}" https://echo.travels.{ocp_cluster_workshop_main_domain}
